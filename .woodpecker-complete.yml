# Woodpecker CI - Complete Autonomous Pipeline
# This is a production-ready pipeline integrating all autonomous features
# Version: 1.0
# Last Updated: 2026-02-08

when:
  event:
    - push
    - pull_request
    - tag
  # Skip CI if commit message contains [skip ci]
  evaluate: 'CI_COMMIT_MESSAGE does not contain "[skip ci]"'

# Global environment variables
environment:
  GRADLE_USER_HOME: /cache/gradle
  ANDROID_HOME: /opt/android-sdk
  CI: true
  ENABLE_AUTONOMY: "true"

# ============================================
# Complete Autonomous Pipeline Steps
# ============================================
steps:
  # ============================================
  # STEP 1: Pre-Build Analysis
  # ============================================
  pre-build-analysis:
    image: android-ci:latest
    commands:
      - echo "=== Pre-Build Analysis ==="

      # Analyze project size for resource allocation
      - /opt/pipeline-utils/scripts/analyze-project-size.sh --yaml > .resource-config.yaml

      # Display recommendations
      - echo "Resource Recommendations:"
      - cat .resource-config.yaml | grep -A5 "resources:"

      # Export resource settings
      - echo "RECOMMENDED_MEMORY=$(cat .resource-config.yaml | grep 'memory:' | awk '{print $2}')" >> .build-env
      - echo "RECOMMENDED_CPU=$(cat .resource-config.yaml | grep 'cpu:' | awk '{print $2}')" >> .build-env
      - source .build-env

    environment:
      CACHE_DIR: /cache/gradle

  # ============================================
  # STEP 2: Cache Freshness Check
  # ============================================
  cache-validation:
    image: android-ci:latest
    commands:
      - echo "=== Cache Validation ==="

      - cd simpleGame

      # Check if cache is fresh
      - |
        if ! /opt/pipeline-utils/scripts/check-cache-freshness.sh; then
          echo "âš ï¸  Cache is stale, invalidating..."
          rm -rf /cache/gradle/caches/*
          rm -rf /cache/gradle/.cache-hash
          echo "âœ“ Cache invalidated"
        else
          echo "âœ“ Cache is fresh"
        fi

      # Display cache statistics
      - |
        if [ -d "/cache/gradle/caches" ]; then
          CACHE_SIZE=$(du -sh /cache/gradle/caches 2>/dev/null | cut -f1)
          CACHE_FILES=$(find /cache/gradle/caches -type f 2>/dev/null | wc -l)
          echo "Cache Size: $CACHE_SIZE"
          echo "Cache Files: $CACHE_FILES"
        fi

    environment:
      CACHE_DIR: /cache/gradle
      PROJECT_DIR: /woodpecker/src/simpleGame

  # ============================================
  # STEP 3: Security Scanning (PR only)
  # ============================================
  security-scan:
    image: android-ci:latest
    commands:
      - echo "=== Security Scanning ==="

      # Scan for secrets
      - |
        if command -v trufflehog > /dev/null 2>&1; then
          echo "Scanning for secrets..."
          trufflehog filesystem --directory . --json --no-failed 2>/dev/null | tee secrets-scan.json || true

          # Check if secrets found
          if [ -s secrets-scan.json ] && [ "$(jq 'length' secrets-scan.json 2>/dev/null || echo 0)" -gt 0 ]; then
            echo "âŒ SECRETS DETECTED!"
            echo "Secrets found in codebase:"
            jq '.' secrets-scan.json
            echo ""
            echo "CRITICAL: Please remove secrets before merging!"
            exit 1
          else
            echo "âœ“ No secrets detected"
          fi
        else
          echo "âŠ˜ TruffleHog not installed, skipping secret scan"
        fi

      # License compliance check
      - |
        if [ -f "simpleGame/build.gradle.kts" ] || [ -f "simpleGame/build.gradle" ]; then
          cd simpleGame
          echo "Checking license compliance..."
          ./gradlew downloadLicenses --no-daemon 2>&1 | grep -E "(FAILED|SUCCESS)" || echo "License check completed"
          echo "âœ“ License compliance check completed"
        fi

    when:
      event:
        - pull_request

  # ============================================
  # STEP 4: Build with Auto-Retry
  # ============================================
  build:
    image: android-ci:latest
    commands:
      - echo "=== Build with Auto-Retry ==="

      - cd simpleGame

      # Apply resource recommendations
      - source ../.build-env 2>/dev/null || echo "Using default resources"

      # Set Gradle options
      - |
        if [ -n "$RECOMMENDED_MEMORY" ]; then
          MEMORY_VAL=$(echo $RECOMMENDED_MEMORY | sed 's/GB/g/')
          export GRADLE_OPTS="-Xmx$MEMORY_VAL -XX:MaxMetaspaceSize=512m -XX:+HeapDumpOnOutOfMemoryError"
          echo "Using memory: $MEMORY_VAL"
        else
          export GRADLE_OPTS="-Xmx4g -XX:MaxMetaspaceSize=512m"
          echo "Using default memory: 4g"
        fi

      # Build with automatic retry on transient failures
      - |
        echo "Starting build with retry logic..."
        /opt/pipeline-utils/scripts/retry-command.sh \
          --max-retries=3 \
          --backoff=exponential \
          --timeout=600 \
          ./gradlew clean assembleDebug --no-daemon --stacktrace 2>&1 | tee build.log

      # Save build status
      - echo "success" > .build-status

      # Display build results
      - echo "âœ“ Build completed successfully"

      # List generated APKs
      - find app/build/outputs/apk -name "*.apk" -exec ls -lh {} \;

    environment:
      GRADLE_USER_HOME: /cache/gradle
      GRADLE_OPTS: "-Xmx4g -XX:MaxMetaspaceSize=512m"

    # Save logs on failure for diagnosis
    failure:
      commands:
        - echo "failure" > .build-status
        - echo "âŒ Build failed, saving logs for diagnosis..."
        - cp build.log .last-build-log

  # ============================================
  # STEP 5: Unit Tests with Auto-Retry
  # ============================================
  unit-tests:
    image: android-ci:latest
    commands:
      - echo "=== Unit Tests ==="

      - cd simpleGame

      # Run tests with retry (tests can be flaky)
      - |
        echo "Running unit tests..."
        /opt/pipeline-utils/scripts/retry-command.sh \
          --max-retries=2 \
          ./gradlew testStandardDebugUnitTest --no-daemon --stacktrace

      # Generate coverage report
      - echo "Generating coverage report..."
      - ./gradlew jacocoTestReport --no-daemon

      # Check coverage threshold
      - |
        echo "Checking coverage threshold..."
        COVERAGE_FILE="app/build/reports/jacoco/testStandardDebug/html/index.html"
        if [ -f "$COVERAGE_FILE" ]; then
          # Extract coverage percentage (simplified)
          COVERAGE=$(grep -oP 'Total.*?\d+%' "$COVERAGE_FILE" | grep -oP '\d+' | head -1 || echo "0")
          echo "Code Coverage: ${COVERAGE}%"

          if [ "$COVERAGE" -lt 50 ]; then
            echo "âš ï¸  Warning: Coverage is below 50% threshold"
            echo "Consider adding more tests"
          else
            echo "âœ“ Coverage meets minimum threshold"
          fi
        else
          echo "âŠ˜ Coverage report not found"
        fi

    environment:
      GRADLE_USER_HOME: /cache/gradle

  # ============================================
  # STEP 6: Lint Analysis
  # ============================================
  lint:
    image: android-ci:latest
    commands:
      - echo "=== Lint Analysis ==="

      - cd simpleGame

      # Run lint with retry
      - |
        /opt/pipeline-utils/scripts/retry-command.sh \
          ./gradlew lintStandardDebug --no-daemon --stacktrace

      # Check lint results
      - |
        LINT_REPORT="app/build/reports/lint-results-StandardDebug.html"
        if [ -f "$LINT_REPORT" ]; then
          echo "âœ“ Lint report generated: $LINT_REPORT"

          # Count issues (simplified)
          ISSUES=$(grep -c "error " "$LINT_REPORT" 2>/dev/null || echo "0")
          echo "Lint issues found: $ISSUES"

          if [ "$ISSUES" -gt 0 ]; then
            echo "âš ï¸  Lint issues detected, please review"
          fi
        else
          echo "âŠ˜ Lint report not found"
        fi

      # Save lint status
      - echo $? > .lint-status

    environment:
      GRADLE_USER_HOME: /cache/gradle

  # ============================================
  # STEP 7: Failure Diagnosis (if build failed)
  # ============================================
  failure-diagnosis:
    image: android-ci:latest
    commands:
      - echo "=== Failure Diagnosis ==="

      - cd simpleGame

      # Check if build failed
      - |
        if [ -f .build-status ] && [ "$(cat .build-status)" = "failure" ]; then
          echo "ðŸ” Build failed, running diagnosis..."

          if [ -f .last-build-log ]; then
            # Run failure diagnosis
            /opt/pipeline-utils/scripts/diagnose-failure.sh .last-build-log

            # Try auto-fix if available
            - |
              echo ""
              echo "Attempting automatic remediation..."

              # Check for OOM errors
              if grep -q "OutOfMemoryError" .last-build-log; then
                echo "Detected OutOfMemoryError, applying fix..."
                export GRADLE_OPTS="-Xmx8g -XX:MaxMetaspaceSize=1g"
                echo "Increased memory allocation"
                echo "Retrying build..."
                ./gradlew assembleDebug --no-daemon
              fi

              # Check for timeout
              if grep -q "TimeoutException" .last-build-log; then
                echo "Detected timeout, this may be a transient issue"
                echo "Consider increasing timeout or optimizing build"
              fi

              # Check for dependency issues
              if grep -q "Could not resolve" .last-build-log; then
                echo "Detected dependency resolution issues"
                echo "Try: ./gradlew build --refresh-dependencies"
              fi
            fi
          else
            echo "âš ï¸  Build log not found for diagnosis"
          fi
        else
          echo "âœ“ Build succeeded, no diagnosis needed"
        fi

    when:
      status:
        - failure

  # ============================================
  # STEP 8: Performance Benchmark (optional)
  # ============================================
  benchmark:
    image: android-ci:latest
    commands:
      - echo "=== Performance Benchmark ==="

      - cd simpleGame

      # Run benchmark if available
      - |
        if ./gradlew tasks --all | grep -q "benchmark"; then
          echo "Running benchmarks..."
          ./gradlew benchmark --no-daemon

          # Compare with baseline if available
          if [ -f "baseline-benchmark.txt" ]; then
            echo "Comparing with baseline..."
            CURRENT=$(cat benchmark-results.txt | grep 'Total:' | awk '{print $2}' || echo "0")
            BASELINE=$(cat baseline-benchmark.txt | grep 'Total:' | awk '{print $2}' || echo "0")

            if [ -n "$CURRENT" ] && [ -n "$BASELINE" ]; then
              echo "Current: $CURRENT, Baseline: $BASELINE"

              # Check for regression (10% threshold)
              if (( $(echo "$CURRENT > $BASELINE * 1.1" | bc -l 2>/dev/null || echo 0) )); then
                echo "âš ï¸  Performance regression detected!"
                echo "Build is slower than baseline by more than 10%"
              else
                echo "âœ“ Performance is acceptable"
              fi
            fi
          else
            echo "No baseline found, saving current results as baseline"
            cp benchmark-results.txt baseline-benchmark.txt
          fi
        else
          echo "âŠ˜ No benchmark tasks found"
        fi

    when:
      event:
        - push
      branch:
        - main
        - develop
      evaluate: BENCHMARK_ENABLED == "true"

  # ============================================
  # STEP 9: Artifact Collection
  # ============================================
  collect-artifacts:
    image: android-ci:latest
    commands:
      - echo "=== Collecting Artifacts ==="

      - cd simpleGame
      - mkdir -p artifacts/{apk,test-results,coverage,lint,benchmark}

      # Copy APK files
      - |
        echo "Collecting APK files..."
        find app/build/outputs/apk -name "*.apk" -exec cp {} artifacts/apk/ \; 2>/dev/null || true
        if [ "$(ls -A artifacts/apk/ 2>/dev/null)" ]; then
          echo "âœ“ APK files collected:"
          ls -lh artifacts/apk/
        else
          echo "âŠ˜ No APK files found"
        fi

      # Copy test results
      - |
        echo "Collecting test results..."
        cp -r app/build/test-results artifacts/test-results/ 2>/dev/null || true
        cp -r app/build/reports/tests artifacts/test-results/ 2>/dev/null || true

      # Copy coverage reports
      - |
        echo "Collecting coverage reports..."
        cp -r app/build/reports/jacoco artifacts/coverage/ 2>/dev/null || true

      # Copy lint reports
      - |
        echo "Collecting lint reports..."
        cp -r app/build/reports/lint* artifacts/lint/ 2>/dev/null || true

      # Copy benchmark results
      - |
        echo "Collecting benchmark results..."
        cp benchmark-results.txt artifacts/benchmark/ 2>/dev/null || true

      # Create artifact summary
      - |
        echo "=== Artifact Summary ===" > artifacts/SUMMARY.txt
        echo "Build: ${CI_BUILD_NUMBER}" >> artifacts/SUMMARY.txt
        echo "Commit: ${CI_COMMIT_SHA}" >> artifacts/SUMMARY.txt
        echo "Branch: ${CI_COMMIT_BRANCH}" >> artifacts/SUMMARY.txt
        echo "Date: $(date)" >> artifacts/SUMMARY.txt
        echo "" >> artifacts/SUMMARY.txt
        echo "APK Files:" >> artifacts/SUMMARY.txt
        ls -lh artifacts/apk/ >> artifacts/SUMMARY.txt 2>/dev/null || echo "None" >> artifacts/SUMMARY.txt

      - cat artifacts/SUMMARY.txt

    when:
      status:
        - success
        - failure

  # ============================================
  # STEP 10: Notification (on failure)
  # ============================================
  notify-failure:
    image: plugins/slack
    settings:
      webhook: {{ secrets.slack_webhook }}
      template: |
        âŒ **Build Failed** - {{ repo.owner }}/{{ repo.name }}

        **Build:** #{{ build.number }}
        **Commit:** {{ commit.sha[:8] }}
        **Author:** {{ commit.author }}
        **Branch:** {{ commit.branch }}
        **Message:** {{ commit.message }}

        {{ if .build-status }}
        **Status:** Build failed during {{ .build-status }} phase
        {{ end }}

        **Diagnosis:**
        Automated diagnosis has been performed. Check the logs for details.

        **View:** {{ build.link }}
    when:
      status:
        - failure
      event:
        - push
        - pull_request

  # ============================================
  # STEP 11: Notification (on success)
  # ============================================
  notify-success:
    image: plugins/slack
    settings:
      webhook: {{ secrets.slack_webhook }}
      template: |
        âœ… **Build Succeeded** - {{ repo.owner }}/{{ repo.name }}

        **Build:** #{{ build.number }}
        **Commit:** {{ commit.sha[:8] }}
        **Author:** {{ commit.author }}
        **Branch:** {{ commit.branch }}

        **Duration:** {{ build.duration }}

        **Artifacts:** {{ build.link }}

        {{ if eq build.event "pull_request" }}
        **PR:** Ready for review! {{ commit.pull_request }}
        {{ end }}
    when:
      status:
        - success
      event:
        - push
        - pull_request

# ============================================
# Volumes Configuration
# ============================================
volumes:
  gradle-cache:
    driver: local
  android-sdk:
    driver: local

# ============================================
# Labels for Scheduling
# ============================================
labels:
  autoscaling: true
  priority: high

# ============================================
# Pipeline Triggers
# ============================================
skip_clone: false

# ============================================
# Notes
# ============================================
#
# This pipeline demonstrates all autonomous features:
#
# 1. Self-Healing:
#    - Automatic retry on failures
#    - Failure diagnosis and remediation
#    - Smart error handling
#
# 2. Intelligent Decision Making:
#    - Adaptive resource allocation
#    - Cache optimization
#    - Performance benchmarking
#
# 3. Security:
#    - Secret scanning
#    - License compliance
#
# 4. Quality Gates:
#    - Test coverage enforcement
#    - Lint checking
#    - Performance regression detection
#
# 5. Automation:
#    - Artifact collection
#    - Notifications
#    - Status tracking
#
# To customize for your project:
# - Update project directory (simpleGame -> your project)
# - Adjust resource recommendations
# - Configure thresholds (coverage, performance)
# - Set up Slack webhook
# - Enable/disable features as needed
#
# For more information, see:
# - AUTONOMY_GUIDE.md - Complete feature documentation
# - MIGRATION_GUIDE.md - How to migrate existing pipelines
# - ROLLOUT_CHECKLIST.md - Production rollout checklist
#
